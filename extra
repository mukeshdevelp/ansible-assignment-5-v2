  ---
- name: Check PostgreSQL user, database, and privileges
  hosts: postgres_servers
  become: yes
  vars:
    postgres_user: "sonarqube"        # The name of the new user
    postgres_password: "12345"        # The password for the new user
    postgres_db: "sonarqube"          # The name of the new database
    postgres_superuser: "postgres"    # The superuser to connect as (typically "postgres")
    postgres_host: "localhost"        # PostgreSQL is on the same machine

  tasks:
    # Check if PostgreSQL user exists by attempting to log in
    - name: Check if PostgreSQL user can log in
      ansible.builtin.shell: |
        PGPASSWORD={{ postgres_password }} psql -U {{ postgres_user }} -h {{ postgres_host }} -c "\q"
      register: login_result
      ignore_errors: yes
    
    - name: Debug login result
      debug:
        msg: "Login result: {{ login_result }}"

    - name: Assert PostgreSQL user login
      assert:
        that:
          - login_result.rc == 0
        fail_msg: "PostgreSQL user {{ postgres_user }} cannot log in with the provided password."

    # Check if the database exists
    - name: Check if PostgreSQL database exists
      ansible.builtin.shell: |
        PGPASSWORD={{ postgres_password }} psql -U {{ postgres_superuser }} -h {{ postgres_host }} -c "\l" | grep -w {{ postgres_db }}
      register: db_check_result
      ignore_errors: yes

    - name: Debug database check result
      debug:
        msg: "Database check result: {{ db_check_result }}"

    - name: Assert PostgreSQL database existence
      assert:
        that:
          - db_check_result.rc == 0
        fail_msg: "Database {{ postgres_db }} does not exist."

    # Check if the user has privileges on the database
    - name: Check if PostgreSQL user has privileges on the database
      ansible.builtin.shell: |
        PGPASSWORD={{ postgres_password }} psql -U {{ postgres_superuser }} -h {{ postgres_host }} -c "SELECT grantee, privilege_type FROM information_schema.role_table_grants WHERE grantee='{{ postgres_user }}' AND table_catalog='{{ postgres_db }}';"
      register: user_privileges
      ignore_errors: yes

    - name: Debug user privileges result
      debug:
        msg: "User privileges result: {{ user_privileges }}"

    - name: Assert PostgreSQL user privileges
      assert:
        that:
          - user_privileges.stdout | search('ALL PRIVILEGES') is not none
        fail_msg: "PostgreSQL user {{ postgres_user }} does not have all privileges on database {{ postgres_db }}."

