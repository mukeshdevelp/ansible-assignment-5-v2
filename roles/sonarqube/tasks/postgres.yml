---
- name: Install postgresql on debian based systems
  block:
    # update caches
    - name: Update apt cache
      apt:
        update_cache: yes
      timeout: 300  # 5 minutes timeout
      retries: 3
      delay: 10
      when: ansible_facts['os_family'] == "Debian"
    
    # install postgresql common for pgdg setup script
    - name: Install postgresql-common
      apt:
        name: postgresql-common
        state: present
      timeout: 300  # 5 minutes timeout
      retries: 3
      delay: 10
      when: ansible_facts['os_family'] == "Debian"
    
    # run the pgscript available in /usr/share/postgresql-common/pgdg with yes so that it can run
    - name: Run PGDG setup script
      shell: 
        cmd: yes | /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh
        creates: /etc/apt/sources.list.d/pgdg.list
      when: ansible_facts['os_family'] == "Debian"
    
    # update apt caches after pgdg script
    - name: Update apt cache after PGDG script
      apt:
        update_cache: yes
      timeout: 300  # 5 minutes timeout
      retries: 3
      delay: 10
      when: ansible_facts['os_family'] == "Debian"
    - name: Install PostgreSQL and contrib
      apt:
        name:
          - postgresql-{{ postgresql_version }}
        state: present
      timeout: 600  # 10 minutes timeout for package installation
      retries: 3
      delay: 10
      when: ansible_facts['os_family'] == "Debian"
      
    - name: Reload systemd
      command: systemctl daemon-reload
      when: ansible_facts['os_family'] == "Debian"
    
    - name: restart postgresql
      service:
        name: postgresql
        state: restarted
        enabled: yes
      when: ansible_facts['os_family'] == "Debian"
    
    # check if postgresql is initialized and enabled
    - name: Ensure PostgreSQL is initialized and running
      service:
        name: postgresql
        state: started
        enabled: yes
      when: ansible_facts['os_family'] == "Debian"
    
    - name: Create Database
      become: yes
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE DATABASE {{ db_name }};"
      register: postgres_db_result

    - name: Create User
      become: yes
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ db_user }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH ENCRYPTED PASSWORD '{{ db_password }}';"
      register: postgres_user_result

    - name: Grant privileges on database
      become: yes
      shell: |
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"
      register: postgres_privileges_result

    - name: Change database owner to db_user
      become: yes
      shell: |
        sudo -u postgres psql -c "ALTER DATABASE {{ db_name }} OWNER TO {{ db_user }};"
      register: postgres_owner_result
    
    - name: Verify database status
      become: yes
      shell: |
        echo "=== Database Status ==="
        sudo -u postgres psql -c "\l {{ db_name }}"
        echo ""
        echo "=== User Status ==="
        sudo -u postgres psql -c "\du {{ db_user }}"
        echo ""
        echo "=== Database Owner ==="
        sudo -u postgres psql -tc "SELECT datname, pg_catalog.pg_get_userbyid(datdba) as owner FROM pg_database WHERE datname='{{ db_name }}';"
      register: db_status_result
      changed_when: false
      
    - name: Display database status
      debug:
        var: db_status_result.stdout_lines
      
    - name: Check if database actually exists
      become: yes
      shell: |
        if sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'" | grep -q 1; then
          echo "✅ Database EXISTS"
        else
          echo "❌ Database NOT FOUND"
        fi
        if sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ db_user }}'" | grep -q 1; then
          echo "✅ User EXISTS"
        else
          echo "❌ User NOT FOUND"
        fi
      register: db_check_final
      changed_when: false
      
    - name: Final database check result
      debug:
        var: db_check_final.stdout_lines
  when: ansible_facts['os_family'] == "Debian"
    #-------------------------working code above this line-----------------------------


# redhat server-----------------------------
# service file locattion: /usr/lib/systemd/system/postgresql-18.service
- name: Install PostgreSQL on RedHat based systems
  block:  
    - name: Update dnf cache
      dnf:
        update_cache: yes
      when: ansible_facts['os_family'] == "RedHat"

    # -------------------------------
    # 1. Add PGDG Repo + GPG Keys
    # ------------------------------
    - name: Install PGDG repo (PostgreSQL, EL-10)
      become: yes
      shell: |
        sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-10-x86_64/pgdg-redhat-repo-latest.noarch.rpm
        # sudo dnf -qy module disable postgresql
      args:
        creates: /etc/yum.repos.d/pgdg-redhat-all.repo
      when: ansible_facts['os_family'] == "RedHat"
    # 2. Install PostgreSQL packages
    
    - name: Install PostgreSQL Server and Client
      become: yes
      dnf:
        name:
          
          - postgresql{{ postgresql_version }}-server
        state: present
      
    - name: Reload systemd
      command: systemctl daemon-reload
      when: ansible_facts['os_family'] == "RedHat"
    
    - name: restart postgresql
      service:
        name: postgresql-{{ postgresql_version }}
        state: restarted
        enabled: yes
      when: ansible_facts['os_family'] == "RedHat"
    # 3. Initialize & start DB service
   
    - name: Initialize PostgreSQL database
      become: yes
      command: /usr/pgsql-{{ postgresql_version }}/bin/postgresql-{{ postgresql_version }}-setup initdb
      args:
        creates: /var/lib/pgsql/{{ postgresql_version }}/data/PG_VERSION

    - name: Ensure PostgreSQL is running and enabled
      become: yes
      service:
        name: postgresql-{{ postgresql_version }}
        state: started
        enabled: yes

    
    - name: Create Database
      become: yes
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE DATABASE {{ db_name }};"
      register: postgres_db_result

    - name: Create User
      become: yes
      shell: |
        sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='{{ db_user }}'" | grep -q 1 \
        || sudo -u postgres psql -c "CREATE USER {{ db_user }} WITH ENCRYPTED PASSWORD '{{ db_password }}';"
      register: postgres_user_result

    - name: Grant privileges on database
      become: yes
      shell: |
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ db_name }} TO {{ db_user }};"
      register: postgres_privileges_result

    - name: Change database owner
      become: yes
      shell: |
        sudo -u postgres psql -c "ALTER DATABASE {{ db_name }} OWNER TO {{ db_user }};"
      register: postgres_owner_result

  when: ansible_facts['os_family'] == "RedHat"
#-----------------------working code above this line ---------------------------------

#-----------------------working code down this line ---------------------------------
- name: Database setup summary
  debug:
    msg:
      - "Database created: {{ postgres_db_result.changed }}"
      - "User created: {{ postgres_user_result.changed }}"
      - "Privileges granted: {{ postgres_privileges_result.changed }}"
      - "Ownership changed: {{ postgres_owner_result.changed }}"
  when: 
    - postgres_user_result is defined
    - postgres_db_result is defined




